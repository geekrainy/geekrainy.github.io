<!DOCTYPE html><html><head><meta charset="utf-8"><title>浅探电子邮件原理 | 雨落</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="电子邮件在生活中无处不在，极大促进了我们的沟通效率。这里，简单探讨下电子邮件的相关工作方式和原理。"><meta property="og:type" content="article"><meta property="og:title" content="浅探电子邮件原理"><meta property="og:url" content="https://rainylog.com/post/how-does-email-work/index.html"><meta property="og:site_name" content="雨落"><meta property="og:description" content="电子邮件在生活中无处不在，极大促进了我们的沟通效率。这里，简单探讨下电子邮件的相关工作方式和原理。"><meta property="og:locale"><meta property="og:image" content="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/mail-service.png"><meta property="og:image" content="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/example-1.png"><meta property="og:image" content="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/example-2.png"><meta property="og:image" content="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/gmail.png"><meta property="article:published_time" content="2016-04-07T11:26:51.000Z"><meta property="article:modified_time" content="2020-12-29T13:35:51.529Z"><meta property="article:author" content="Rainy"><meta property="article:tag" content="技术"><meta property="article:tag" content="网络"><meta property="article:tag" content="Email"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/mail-service.png"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-99171848-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-99171848-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><meta name="generator" content="Hexo 5.1.0"><link rel="alternate" href="/atom.xml" title="雨落" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">雨 </span><span class="b">落 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-how-does-email-work" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">浅探电子邮件原理</h1><div class="article-meta">Posted on <time class="article-time" datetime="2016-04-07T11:26:51.000Z" itemprop="datePublished">Apr 7, 2016</time></div></header><div class="article-entry" itemprop="articleBody"><p>电子邮件在生活中无处不在，极大促进了我们的沟通效率。这里，简单探讨下电子邮件的相关工作方式和原理。</p><p><img src="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/mail-service.png" alt="电子邮件系统" title="电子邮件系统"></p><a id="more"></a><p>图中可以看到，每个用户通过自己的<strong>用户代理(user agent)**和</strong>邮件服务器(mail server)<strong>通讯，邮件服务器之间通过 SMTP 协议来进行通讯。邮件服务器形成了电子邮件体系结构的核心。每个用户在邮件服务器上有一个</strong>邮箱(mailbox)**，就是邮箱在打理着每个用户的邮件数据，接收或是删除。假设 A 向 B 发送一封邮件，典型的过程是这样的：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">A</span> --<span class="literal">-</span><span class="comment">(SMTP)</span>--<span class="literal">-</span>&gt; <span class="comment">Mail</span> <span class="comment">Server(A)</span> --<span class="literal">-</span><span class="comment">(SMTP)</span>--<span class="literal">-</span>&gt; <span class="comment">Mail</span> <span class="comment">Server(B)</span> --<span class="literal">-</span><span class="comment">?</span>--<span class="literal">-</span>&gt; <span class="comment">B</span></span><br></pre></td></tr></table></figure><p>前面说到，邮件服务器形成了电子邮件体系结构的核心，而 SMTP 则可称为电子邮件应用的核心。SMTP 的诞生早于 HTTP，说明了它具有某些过时的特性，比如：它限制所有邮件报文的体部分只能采用简单的 7 比特 ASCII 码来传输。对于今天的各种附件、图片、媒体资源来说，必须先经过转码才能通过 SMTP 协议发送出去，显然这降低了邮件传输的效率。然而，SMTP 能够延续到今天仍在使用，说明它有着自己足够吸引人的特性。</p><p>SMTP 一般情况下不通过中间邮件服务器来发送邮件，所以，如果 A 给 B 发送邮件时，B 的邮件服务器故障或者未开机，那么该邮件会留存在 A 的邮件服务器上等待并尝试重新发送，而不会遗落在其它邮件服务器上。</p><p><img src="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/example-1.png" alt="Alice 向 Bob 发送一条报文" title="Alice 向 Bob 发送一条报文"></p><p>以 Alice 和 Bob 为例发送一个邮件报文：</p><ol><li>Alice 提供 Bob 的邮件地址，撰写报文，指示用户代理发送报文。</li><li>通过用户代理投送到 Alice 的邮件服务器，放入**报文队列(message queue)**中。</li><li>Alice 的邮件服务器将邮件报文发送至 Bob 的邮件服务器，在这个过程中，Alice 的邮件服务器充当客户，Bob 的邮件服务器充当服务器。SMTP 客户端将与 SMTP 服务器建立 TCP 连接。</li><li>一旦连接建立，将进行一系列的 SMTP 握手过程，随后将邮件报文发送至服务器。如果连接无法建立，将邮件报文放入**报文队列(message queue)**中，等待再次尝试发送。</li><li>在 Bob 的邮件服务器上，SMTP 的服务器端接收到该报文。Bob 的邮件服务器然后将报文放入 Bob 的邮箱中。</li><li>Bob 有空闲时可以通过用户代理阅读报文。</li></ol><p>注意到 SMTP 协议与 HTTP 有很大的不同，SMTP 基本可看作是一个**推协议(push protocol)**，这个 TCP 连接需要由发送文件的机器发起。对应上述示例中 Alice 向 Alice 的邮件服务器发送报文过程和 Alice 的邮件服务器向 Bob 的邮件服务器发送过程。当目标服务器不可达时，Alice 的用户代理没有办法将电子邮件报文发送到目标服务器，需要 Alice 进行重试，而通过两次 SMTP 的过程分离了 Alice 的在线约束条件，一切交给邮件服务器去重试。这就导致一个问题，Bob 并不总是在线，Bob 的邮件服务器不可能保证 Bob 的用户代理一直可用，所以 Bob 邮箱中的报文需要 Bob 在线的时候主动去获取。现在的电子邮件系统以是存储与转发的模型为基础。邮件服务器接受、转发、提交及存储邮件。寄信人、收信人及他们的电脑都不用同时在线。寄信人和收信人只需在寄信或收信时简短的连接到邮件服务器即可。实现这样的体系仅仅有 SMTP 是不够的，因而需要其它协议来配合。</p><p><img src="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/example-2.png" alt="报文发送中的协议" title="报文发送中的协议"></p><p>为了使 Bob 能够从自己的邮件服务器中拉取邮件，需要引入一个特殊的邮件访问协议。流行的邮件访问协议有 <strong>邮局协议第三版(Post Office Protocol-Version 3, POP3)**、</strong>因特网邮件访问协议(Internet Mail Access Protocol, IMAP)**。</p><p>POP3 由 RFC 1939 定义。其过程为用户代理建立到邮件服务器 110 端口的 TCP 连接，POP3 按照三个阶段进行工作：特许、事务处理及更新。特许阶段用户代理以明文发送用户名和口令鉴别用户。第二个阶段可以做三件事情：取回邮件报文，标记要删除的邮件或取消标记，获取邮件统计信息。在最后的更新阶段，结束 POP3 会话并处理删除标记。</p><p>IMAP 服务相比 POP3 的优点是，它将每个报文与一个文件夹相联系。当报文第一次到达服务器，它与收件人的 INBOX 文件夹相关联。收件人可以移动到新的文件夹、阅读或是删除邮件。IMAP 也提供了远程查询的命令，可以条件匹配查询邮件信息。与 POP3 不同的是，IMAP 维护会话过程的用户状态信息，比如每个报文的文件夹关联。另一个重要特性是允许只获取报文的一部分，比如常用的移动设备都有在 wifi 下下载附件的功能，在普通网络下则只会加载邮件标题和摘要，点击全文下载完整邮件。</p><p><img src="https://rainylog-1256215078.cos.ap-shanghai.myqcloud.com/images/gmail.png" alt="Gmail 中的 POP3 和 IMAP 协议设置" title="Gmail 中的 POP3 和 IMAP 协议设置"></p><p>另外，在上面的示例图中，Bob 获取报文还有一种方式是通过 HTTP，电子邮件怎么又和 Web 扯上关系了呢？</p><p>在早期，电子邮件的用户代理都是客户端软件，20 世纪 90 年代中期，hotmail 推出基于 Web 的邮件服务，大大方便了邮件使用。谷歌的 Gmail 则是一个 Web 软件的精彩范例。当使用基于 Web 的电子邮件服务时，发件人和收件人的用户代理(Web 邮件服务)与邮件服务器之间通过 HTTP 协议发送和接收邮件报文。但在邮件服务器之间，仍使用 SMTP 协议来发送报文。</p><p>END</p><p>参考：</p><ol><li><em>《Computer Networking: A Top-Down Approach (6th Edition)》</em></li><li><em><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Email">Email</a></em></li><li><em><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">Simple Mail Transfer Protocol</a></em></li><li><em><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Post_Office_Protocol">Post Office Protocol</a></em></li></ol><div class="article-copyright"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external"><span class="icon icon-creative-commons"></span> <span>本博客所有文章除特别声明外，均采用 CC BY-NC-ND 4.0 许可协议。转载请注明出处！</span> </a><a href="https://rainylog.com">&copy; 雨落</a></div></div><div class="article-tags"><a class="tag-none-link" href="/tags/Email/" rel="tag">Email</a><a class="tag-none-link" href="/tags/%E6%8A%80%E6%9C%AF/" rel="tag">技术</a><a class="tag-none-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></div><nav class="article-nav clearfix"><a href="/post/ife-note-2/" class="article-nav-newer"><div class="article-nav-title">IFE-NOTE：文本级语义化</div></a><a href="/post/ife-note-1/" class="article-nav-older"><div class="article-nav-title">IFE-NOTE：页面结构语义化</div></a></nav><section id="comments" class="white-box"></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://rainylog.com">雨落</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external noopener">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.gif"></div><div class="info"><a class="name dark-btn" href="/about">Rainy</a></div><div class="info"><span class="item desc">沉淀，分享。</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto://geekrainy@gmail.com" class="email" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/geekrainy" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://weibo.com/geekrainy" class="weibo" target="_blank" rel="external"><span class="icon icon-weibo"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="rainylog",AZURE_INDEX_NAME="rainylog",AZURE_QUERY_KEY="FDEE6CFE3AB9A25E574BBCB873B29595",BAIDU_API_ID="",SEARCH_SERVICE="azure"</script><script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script type="text/javascript">var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!0,notify:!0,appId:"H90zpiwhe0XxV8Kb8n6BplHo-MdYXbMMI",appKey:"974axFeQbAqLnxwJIRgc1xHa",placeholder:"Just go go",avatar:"retro",meta:guest,pageSize:10,visitor:!0})</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>