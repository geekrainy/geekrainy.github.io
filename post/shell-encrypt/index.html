<!DOCTYPE html><html><head><meta charset="utf-8"><title>一次 Shell 脚本加密探索 | 雨落</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="遇到一个需求，要求 a 切换到 b 用户执行一些操作，但是 b 用户的目录等不能授权给 a 访问。探索一番具体有下列方式。 第一次尝试方案在 b 用户下建立脚本 target.sh，a 用户下建立一个中间脚本脚本 helper.sh，在 helper.sh 中通过 su 命令切换用户过去，而 su 命令需要输入密码的过程，当然，b 用户的密码是不能暴露给 a 的。 编写 helper.sh 内容如"><meta property="og:type" content="article"><meta property="og:title" content="一次 Shell 脚本加密探索"><meta property="og:url" content="https://rainylog.com/post/shell-encrypt/index.html"><meta property="og:site_name" content="雨落"><meta property="og:description" content="遇到一个需求，要求 a 切换到 b 用户执行一些操作，但是 b 用户的目录等不能授权给 a 访问。探索一番具体有下列方式。 第一次尝试方案在 b 用户下建立脚本 target.sh，a 用户下建立一个中间脚本脚本 helper.sh，在 helper.sh 中通过 su 命令切换用户过去，而 su 命令需要输入密码的过程，当然，b 用户的密码是不能暴露给 a 的。 编写 helper.sh 内容如"><meta property="og:locale"><meta property="article:published_time" content="2018-01-16T10:55:47.000Z"><meta property="article:modified_time" content="2020-12-29T13:35:51.529Z"><meta property="article:author" content="Rainy"><meta property="article:tag" content="bash"><meta property="article:tag" content="shell"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-99171848-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-99171848-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><meta name="generator" content="Hexo 5.1.0"><link rel="alternate" href="/atom.xml" title="雨落" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">雨 </span><span class="b">落 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-shell-encrypt" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">一次 Shell 脚本加密探索</h1><div class="article-meta">Posted on <time class="article-time" datetime="2018-01-16T10:55:47.000Z" itemprop="datePublished">Jan 16, 2018</time></div></header><div class="article-entry" itemprop="articleBody"><p>遇到一个需求，要求 a 切换到 b 用户执行一些操作，但是 b 用户的目录等不能授权给 a 访问。探索一番具体有下列方式。</p><h2 id="第一次尝试"><a href="#第一次尝试" class="headerlink" title="第一次尝试"></a>第一次尝试</h2><h3 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h3><p>在 b 用户下建立脚本 <code>target.sh</code>，a 用户下建立一个中间脚本脚本 <code>helper.sh</code>，在 helper.sh 中通过 su 命令切换用户过去，而 su 命令需要输入密码的过程，当然，b 用户的密码是不能暴露给 a 的。</p><p>编写 helper.sh 内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">runUserPassword=&#x27;password&#x27;</span><br><span class="line">arg1=$1</span><br><span class="line">arg2=$2</span><br><span class="line">arg3=$3</span><br><span class="line">/usr/bin/expect -f ./helper.exp $&#123;runUserPassword&#125; $&#123;arg1&#125; $&#123;arg2&#125; $&#123;arg3&#125;</span><br></pre></td></tr></table></figure><p>利用 expect 去为我们输入密码，所以脚本中调用了 helper.exp，内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line">set timeout 600</span><br><span class="line">set runUserPassword [lindex $argv 0]</span><br><span class="line">set arg1 [lindex $argv 1]</span><br><span class="line">set arg2 [lindex $argv 2]</span><br><span class="line">set arg3 [lindex $argv 3]</span><br><span class="line"></span><br><span class="line">spawn su - rfc</span><br><span class="line">expect &quot;:&quot;</span><br><span class="line">send &quot;$runUserPassword\r&quot;</span><br><span class="line">send &quot;./target.sh $arg1 $arg2 $arg3\r&quot;</span><br><span class="line">send &quot;exit\r&quot;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure><p>要将用户密码传入 expect 的执行脚本内，由于无法对 expect 文件进行二进制加密，所以将密码保存在 helper.sh 内，在执行时通过参数传入 expect 内。</p><p>随后通过 shc 进行加密，helper.sh 被编译为二进制执行文件，保存其中的明文密码无法被查看。</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>通过这种方式乍看很完美，但是在实际的执行过程中发现，在运行脚本的过程中输入 <code>ctrl+z</code> 发出中断信号，执行会停止，停留在 a 用户的执行环境中。这样 b 用户就获得了 a 用户的环境，前功尽弃了。</p><p>后来尝试在脚本中捕获中断信号，在 shell script 中添加：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trap &quot;&quot; SIGINT</span><br></pre></td></tr></table></figure><p>仍无法解决，它只能忽略 shell 中的中断信号，而我们调用了 expect，无法处理。</p><p>查询 expect 的用法，发现了类似的语法：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trap SIG_IGN &#123; SIGINT SIGHUP SIGQUIT&#125;</span><br></pre></td></tr></table></figure><p>但是在 exp 中配置 <code>trap SIG_IGN SIGINT</code> 无效果，不知原因，因而此方案废弃，改用第二种方案。</p><h2 id="第二次尝试"><a href="#第二次尝试" class="headerlink" title="第二次尝试"></a>第二次尝试</h2><h3 id="方案-1"><a href="#方案-1" class="headerlink" title="方案"></a>方案</h3><p>既然 expect 会有中断的问题，那么就只能避免使用 expect，想到使用 ssh 来进行登陆和验证。</p><p>添加 b 用户的公钥到 a 用户认证文件，这样 b 用户可以使用密钥登陆 a 用户。为了保证 b 用户无法在脚本外登陆到 a 用户，所以这里的密钥生成过程中需要密码。密码保留，这样就可以避免此问题。</p><p>这里又回到了交互式输入密码的问题上，既然 expect 是不可行的，那就只能寻找其它方案。查找资料发现了 <a target="_blank" rel="noopener" href="https://sourceforge.net/projects/sshpass/">sshpass</a> 这个工具，它能帮助我们在 ssh 登陆中输入明文密码。</p><p>用法：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p password ssh a@localhost</span><br></pre></td></tr></table></figure><p>不过我这里输入后无响应，随后发现 sshpass 只能响应密码输入，无法响应加密密钥的密码输入。</p><p>回到原点，撤销密钥登陆，仍旧使用密码登陆。随意 helper.sh 可以这样写：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">runUserPassword=&#x27;password&#x27;</span><br><span class="line">arg1=$1</span><br><span class="line">arg2=$2</span><br><span class="line">arg3=$3</span><br><span class="line">sshpass -p &quot;$runUserPassword&quot; ssh a@127.0.0.1 ./target.sh $&#123;arg1&#125; $&#123;arg2&#125; $&#123;arg3&#125;</span><br></pre></td></tr></table></figure><p>使用 shc 加密，密码同样可以被保护。</p><h3 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h3><p>这里为了实现功能引入了额外的软件 sshpass，网上不建议将该软件用于生产环境，容易引发安全问题。所以尽可能使用 Linux 自带的命令来实现，就有了第三次尝试。</p><h2 id="第三次尝试"><a href="#第三次尝试" class="headerlink" title="第三次尝试"></a>第三次尝试</h2><h3 id="方案-2"><a href="#方案-2" class="headerlink" title="方案"></a>方案</h3><p>思路同第二种方法一样，都是将密码传入保留，不同的是这里用到了内置的 sudo 命令而不需要安装 sshpass。</p><p>将第二种方案最后一行改写一下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">runUserPassword=&#x27;password&#x27;</span><br><span class="line">arg1=$1</span><br><span class="line">arg2=$2</span><br><span class="line">arg3=$3</span><br><span class="line">echo $runUserPassword | sudo -S su - a &quot;./target.sh&quot; $&#123;arg1&#125; $&#123;arg2&#125; $&#123;arg3&#125;</span><br></pre></td></tr></table></figure><p>sudo 命令的 -S 选项可以接受一个标准输入作为密码传递，同样的可以被加密，实现功能。</p><p>有一个不足是自带的 sudo 命令会有一个默认的超时时间，在该事件内使用 sudo 命令无需输入密码，使用者第一次执行后在一段时间内是可以用 sudo 去执行任何操作的，这是危险的。所以要配置为每次执行 sudo 命令都输入密码。</p><p>用 root 用户执行 <code>visudo</code>，找到下列行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Defaults    env_reset</span><br></pre></td></tr></table></figure><p>将其修改为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Defaults    env_reset,timestamp_timeout=0</span><br></pre></td></tr></table></figure><p>这样每次执行 sudo 都需要输入密码了，保证了安全。</p><h3 id="不足-1"><a href="#不足-1" class="headerlink" title="不足"></a>不足</h3><p>这种方式的不足在于更改了 sudo 的默认行为，每次都需要输入密码，对其它用户来讲操作不便。</p><p>第二个不足就是在输出结果时，返回的结果会同密码输入提示在同一行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[b@localhost ~]$ ./helper test test</span><br><span class="line">[sudo] password for b: &quot;输出结果&quot;</span><br></pre></td></tr></table></figure><p>显示效果不美观，待解决。</p><h2 id="SHC-加密的注意事项"><a href="#SHC-加密的注意事项" class="headerlink" title="SHC 加密的注意事项"></a>SHC 加密的注意事项</h2><p>在某一平台上通过 shc 加密生成的二进制文件是动态链接形式，因而在其它平台无法运行。在其它平台运行可能导致服务器宕机。</p><p>可以通过下面的方法生成静态链接的二进制可执行文件：</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFLAGs=-<span class="keyword">static</span> shc -r -f <span class="keyword">helper</span>.sh</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a target="_blank" rel="noopener" href="http://blog.csdn.net/boyishachang/article/details/8677936">http://blog.csdn.net/boyishachang/article/details/8677936</a></li><li><a target="_blank" rel="noopener" href="http://blog.csdn.net/xushx_bigbear/article/details/12966625">http://blog.csdn.net/xushx_bigbear/article/details/12966625</a></li><li><a target="_blank" rel="noopener" href="https://sourceforge.net/projects/sshpass/">https://sourceforge.net/projects/sshpass/</a></li><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yuzhoushenqi/p/6950425.html">https://www.cnblogs.com/yuzhoushenqi/p/6950425.html</a></li><li><a target="_blank" rel="noopener" href="http://www.datsi.fi.upm.es/~frosal/sources/">http://www.datsi.fi.upm.es/~frosal/sources/</a></li></ul><p>-EOF-</p><div class="article-copyright"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external"><span class="icon icon-creative-commons"></span> <span>本博客所有文章除特别声明外，均采用 CC BY-NC-ND 4.0 许可协议。转载请注明出处！</span> </a><a href="https://rainylog.com">&copy; 雨落</a></div></div><div class="article-tags"><a class="tag-none-link" href="/tags/bash/" rel="tag">bash</a><a class="tag-none-link" href="/tags/shell/" rel="tag">shell</a></div><nav class="article-nav clearfix"><a href="/post/my-memory-novel/" class="article-nav-newer"><div class="article-nav-title">初二的小说</div></a><a href="/post/2017-2018/" class="article-nav-older"><div class="article-nav-title">2017 年终总结</div></a></nav><section id="comments" class="white-box"></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://rainylog.com">雨落</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external noopener">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">1.</span> <span class="toc-text">第一次尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.</span> <span class="toc-text">方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">2.</span> <span class="toc-text">第二次尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88-1"><span class="toc-number">2.1.</span> <span class="toc-text">方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3"><span class="toc-number">2.2.</span> <span class="toc-text">不足</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">第三次尝试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88-2"><span class="toc-number">3.1.</span> <span class="toc-text">方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3-1"><span class="toc-number">3.2.</span> <span class="toc-text">不足</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SHC-%E5%8A%A0%E5%AF%86%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.</span> <span class="toc-text">SHC 加密的注意事项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.gif"></div><div class="info"><a class="name dark-btn" href="/about">Rainy</a></div><div class="info"><span class="item desc">沉淀，分享。</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto://geekrainy@gmail.com" class="email" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/geekrainy" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://weibo.com/geekrainy" class="weibo" target="_blank" rel="external"><span class="icon icon-weibo"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="rainylog",AZURE_INDEX_NAME="rainylog",AZURE_QUERY_KEY="FDEE6CFE3AB9A25E574BBCB873B29595",BAIDU_API_ID="",SEARCH_SERVICE="azure"</script><script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script type="text/javascript">var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!0,notify:!0,appId:"H90zpiwhe0XxV8Kb8n6BplHo-MdYXbMMI",appKey:"974axFeQbAqLnxwJIRgc1xHa",placeholder:"Just go go",avatar:"retro",meta:guest,pageSize:10,visitor:!0})</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>