<!DOCTYPE html><html><head><meta charset="utf-8"><title>CentOS7 单节点 k8s 部署拾遗 | 雨落</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="本文讲使用 kubeadm 来安装 k8s，环境为 CentOS 7.5。 kubeadm 安装由于无法访问 google，需要配置阿里的镜像仓库来安装 kubeadm： 123456789101112cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo[kubernetes]name&#x3D;Kubernetesbaseurl&#x3D;https:&#x2F;&#x2F;mir"><meta property="og:type" content="article"><meta property="og:title" content="CentOS7 单节点 k8s 部署拾遗"><meta property="og:url" content="https://rainylog.com/post/install-k8s-on-centos7/index.html"><meta property="og:site_name" content="雨落"><meta property="og:description" content="本文讲使用 kubeadm 来安装 k8s，环境为 CentOS 7.5。 kubeadm 安装由于无法访问 google，需要配置阿里的镜像仓库来安装 kubeadm： 123456789101112cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo[kubernetes]name&#x3D;Kubernetesbaseurl&#x3D;https:&#x2F;&#x2F;mir"><meta property="og:locale"><meta property="article:published_time" content="2018-11-18T06:24:24.000Z"><meta property="article:modified_time" content="2020-12-29T13:35:51.529Z"><meta property="article:author" content="Rainy"><meta property="article:tag" content="k8s"><meta property="article:tag" content="docker"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-99171848-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-99171848-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><meta name="generator" content="Hexo 5.1.0"><link rel="alternate" href="/atom.xml" title="雨落" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">雨 </span><span class="b">落 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-install-k8s-on-centos7" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">CentOS7 单节点 k8s 部署拾遗</h1><div class="article-meta">Posted on <time class="article-time" datetime="2018-11-18T06:24:24.000Z" itemprop="datePublished">Nov 18, 2018</time></div></header><div class="article-entry" itemprop="articleBody"><p>本文讲使用 kubeadm 来安装 k8s，环境为 CentOS 7.5。</p><h2 id="kubeadm-安装"><a href="#kubeadm-安装" class="headerlink" title="kubeadm 安装"></a>kubeadm 安装</h2><p>由于无法访问 google，需要配置阿里的镜像仓库来安装 kubeadm：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">setenforce 0</span><br><span class="line">yum install -y kubelet kubeadm kubectl</span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure><p>按照文档 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">https://kubernetes.io/docs/setup/independent/install-kubeadm/</a> 安装 kubeadm 后，执行 systemctl start kubelet，查看状态，报如下错误：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# systemctl status kubelet</span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /etc/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: activating (auto-restart) (Result: exit-code) since Sun 2018-11-18 11:04:07 CST; 54ms ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line">  Process: 2003 ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS (code=exited, status=255)</span><br><span class="line"> Main PID: 2003 (code=exited, status=255)</span><br><span class="line"></span><br><span class="line">Nov 18 11:04:07 k8s systemd[1]: Unit kubelet.service entered failed state.</span><br><span class="line">Nov 18 11:04:07 k8s systemd[1]: kubelet.service failed.</span><br></pre></td></tr></table></figure><p>这里的坑在于文档里不会告诉你在 init 之前是铁定报错的，在 init 之后查看状态一切 OK。汗</p><h2 id="kubeadm-init-踩坑"><a href="#kubeadm-init-踩坑" class="headerlink" title="kubeadm init 踩坑"></a>kubeadm init 踩坑</h2><p>按照文档 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">https://kubernetes.io/docs/setup/independent/install-kubeadm/</a> 安装 kubeadm，执行初始化，报错。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# kubeadm init</span><br><span class="line">[init] using Kubernetes version: v1.12.2</span><br><span class="line">[preflight] running pre-flight checks</span><br><span class="line">	[WARNING Firewalld]: firewalld is active, please ensure ports [6443 10250] are open or your cluster may not function correctly</span><br><span class="line">[preflight] The system verification failed. Printing the output from the verification:</span><br><span class="line">KERNEL_VERSION: 3.10.0-862.14.4.el7.x86_64</span><br><span class="line">CONFIG_NAMESPACES: enabled</span><br><span class="line">CONFIG_NET_NS: enabled</span><br><span class="line">CONFIG_PID_NS: enabled</span><br><span class="line">CONFIG_IPC_NS: enabled</span><br><span class="line">CONFIG_UTS_NS: enabled</span><br><span class="line">CONFIG_CGROUPS: enabled</span><br><span class="line">CONFIG_CGROUP_CPUACCT: enabled</span><br><span class="line">CONFIG_CGROUP_DEVICE: enabled</span><br><span class="line">CONFIG_CGROUP_FREEZER: enabled</span><br><span class="line">CONFIG_CGROUP_SCHED: enabled</span><br><span class="line">CONFIG_CPUSETS: enabled</span><br><span class="line">CONFIG_MEMCG: enabled</span><br><span class="line">CONFIG_INET: enabled</span><br><span class="line">CONFIG_EXT4_FS: enabled (as module)</span><br><span class="line">CONFIG_PROC_FS: enabled</span><br><span class="line">CONFIG_NETFILTER_XT_TARGET_REDIRECT: enabled (as module)</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_COMMENT: enabled (as module)</span><br><span class="line">CONFIG_OVERLAY_FS: enabled (as module)</span><br><span class="line">CONFIG_AUFS_FS: not set - Required for aufs.</span><br><span class="line">CONFIG_BLK_DEV_DM: enabled (as module)</span><br><span class="line">DOCKER_VERSION: 18.09.0</span><br><span class="line">OS: Linux</span><br><span class="line">CGROUPS_CPU: enabled</span><br><span class="line">CGROUPS_CPUACCT: enabled</span><br><span class="line">CGROUPS_CPUSET: enabled</span><br><span class="line">CGROUPS_DEVICES: enabled</span><br><span class="line">CGROUPS_FREEZER: enabled</span><br><span class="line">CGROUPS_MEMORY: enabled</span><br><span class="line">	[WARNING Hostname]: hostname &quot;k8s&quot; could not be reached</span><br><span class="line">	[WARNING Hostname]: hostname &quot;k8s&quot; lookup k8s on 116.228.111.118:53: no such host</span><br><span class="line">[preflight] Some fatal errors occurred:</span><br><span class="line">	[ERROR Swap]: running with swap on is not supported. Please disable swap</span><br><span class="line">	[ERROR SystemVerification]: unsupported docker version: 18.09.0</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br></pre></td></tr></table></figure><p>巨大的 ERROR 错误，kubeadm 不支持 18.09 的 Docker 版本，只得降级。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum downgrade docker-ce-18.06.1.ce</span><br></pre></td></tr></table></figure><p>用 yum 直接这样降级会报一堆文件冲突错误：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transaction check error:</span><br><span class="line">  file /usr/bin/docker from install of docker-ce-18.06.1.ce-3.el7.x86_64 conflicts with file from package docker-ce-cli-1:18.09.0-3.el7.x86_64</span><br><span class="line">  file /usr/share/bash-completion/completions/docker from install of docker-ce-18.06.1.ce-3.el7.x86_64 conflicts with file from package docker-ce-cli-1:18.09.0-3.el7.x86_64</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>好吧，只得卸载重新安装指定版本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep docker # 查找并逐个卸载</span><br><span class="line">rm -rf /var/lib/docker # 删除旧的镜像信息等</span><br></pre></td></tr></table></figure><p>重新安装低版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update &amp;&amp; yum install docker-ce-18.06.1.ce</span><br></pre></td></tr></table></figure><p>建议还是按照 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/cri/">CRI installation</a> 的步骤来进行安装。</p><p>提示要禁用 swap 分区，查找资料说是为了性能考虑，所以 k8s 默认是不允许使用交换分区的。可以添加kubelet 参数 <code>--fail-swap-on=false</code> 来启用 swap，这里同样进行关闭。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br></pre></td></tr></table></figure><p>将 /etc/fstab 中的 swap 挂载删除以永久禁用 swap。</p><p>还有一个报错是更改主机名忘记加 hosts 中，把 hostname 加入 hosts 文件中问题解决。</p><h2 id="无法下载镜像"><a href="#无法下载镜像" class="headerlink" title="无法下载镜像"></a>无法下载镜像</h2><p>kubeadm 初始化时会从 <a target="_blank" rel="noopener" href="https://k8s.gcr.io/v2/">https://k8s.gcr.io/v2/</a> 拉取镜像，国内无法访问。</p><p>先将 docker 的镜像改为 daocloud 的镜像，官网提供了一键配置镜像的脚本。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io</span><br></pre></td></tr></table></figure><p>执行之后重启 docker 失败，查看该脚本排查原因，做了一件事情，将 <code>/etc/docker/daemon.json</code> 备份，生成新的 daemon.json，打开新生成的内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s docker]# cat daemon.json</span><br><span class="line">&#123;&quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;&quot;registry-mirrors&quot;: [&quot;http://f1361db2.m.daocloud.io&quot;],</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显这里替换错误，将 log-opts 下面也进行了替换，删掉多余的配置之后启动成功，在此不得不吐槽下，脚本写好得测试呀，何况还是 daocloud 这种企业。</p><p>在 github 有这样的仓库 <a target="_blank" rel="noopener" href="https://github.com/mritd/gcr">https://github.com/mritd/gcr</a> 提供了官方镜像的同步，我们要从 hub 上面拉取改仓库的同步镜像 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/gcrxio/">https://hub.docker.com/r/gcrxio/</a> ，将所需的镜像 pull 下来。</p><p>查看当前 k8s 版本需要哪些镜像：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# kubeadm config images list</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.12.2</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.12.2</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.12.2</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.12.2</span><br><span class="line">k8s.gcr.io/pause:3.1</span><br><span class="line">k8s.gcr.io/etcd:3.2.24</span><br><span class="line">k8s.gcr.io/coredns:1.2.2</span><br></pre></td></tr></table></figure><p>拉取：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker pull gcrxio/kube-apiserver:v1.12.2</span><br><span class="line">docker pull gcrxio/kube-controller-manager:v1.12.2</span><br><span class="line">docker pull gcrxio/kube-scheduler:v1.12.2</span><br><span class="line">docker pull gcrxio/kube-proxy:v1.12.2</span><br><span class="line">docker pull gcrxio/pause:3.1</span><br><span class="line">docker pull gcrxio/etcd:3.2.24</span><br><span class="line">docker pull gcrxio/coredns:1.2.2</span><br><span class="line"></span><br><span class="line">docker tag gcrxio/kube-apiserver:v1.12.2 k8s.gcr.io/kube-apiserver:v1.12.2</span><br><span class="line">docker tag gcrxio/kube-controller-manager:v1.12.2 k8s.gcr.io/kube-controller-manager:v1.12.2</span><br><span class="line">docker tag gcrxio/kube-scheduler:v1.12.2 k8s.gcr.io/kube-scheduler:v1.12.2</span><br><span class="line">docker tag gcrxio/kube-proxy:v1.12.2 k8s.gcr.io/kube-proxy:v1.12.2</span><br><span class="line">docker tag gcrxio/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line">docker tag gcrxio/etcd:3.2.24 k8s.gcr.io/etcd:3.2.24</span><br><span class="line">docker tag gcrxio/coredns:1.2.2 k8s.gcr.io/coredns:1.2.2</span><br></pre></td></tr></table></figure><p>再次执行 <code>kubeadm init</code> 初始化成功。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.1.102:6443 --token xxxxxxxxxxxxxxxx --discovery-token-ca-cert-hash sha256:xxxxxxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure><h2 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h2><p>网络插件有多种选择，看教程一众的 weave，在此使用 weave。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span><br><span class="line">serviceaccount/weave-net created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">role.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">daemonset.extensions/weave-net created</span><br></pre></td></tr></table></figure><p>安装 weave scope:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# kubectl apply -f &quot;https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span><br><span class="line">namespace/weave created</span><br><span class="line">serviceaccount/weave-scope created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-scope created</span><br><span class="line">deployment.apps/weave-scope-app created</span><br><span class="line">service/weave-scope-app created</span><br><span class="line">daemonset.extensions/weave-scope-agent created</span><br></pre></td></tr></table></figure><p>执行命令验证是否安装成功：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s ~]# kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-576cbf47c7-vlfnl          1/1     Running   1          9m35s</span><br><span class="line">kube-system   coredns-576cbf47c7-xhmnz          1/1     Running   1          9m35s</span><br><span class="line">kube-system   etcd-k8s                          1/1     Running   0          8m40s</span><br><span class="line">kube-system   kube-apiserver-k8s                1/1     Running   0          8m43s</span><br><span class="line">kube-system   kube-controller-manager-k8s       1/1     Running   0          8m37s</span><br><span class="line">kube-system   kube-proxy-8xwvn                  1/1     Running   0          9m35s</span><br><span class="line">kube-system   kube-scheduler-k8s                1/1     Running   0          8m52s</span><br><span class="line">kube-system   weave-net-vw7ww                   2/2     Running   0          8m6s</span><br><span class="line">weave         weave-scope-agent-n6cq6           1/1     Running   0          3m50s</span><br><span class="line">weave         weave-scope-app-dccf9fd7c-9tdls   1/1     Running   0          3m50s</span><br></pre></td></tr></table></figure><p>看到 coredns 处于运行状态，证明网络环境 OK。</p><h2 id="创建-Pod"><a href="#创建-Pod" class="headerlink" title="创建 Pod"></a>创建 Pod</h2><p>默认情况下集群容器不会运行于 master 节点，要在 master 节点创建 Pod，需要将 master 节点的 taint 去掉，否则普通的 Pod 默认不会调度。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure><p>至此便完成了单个节点的 k8s 安装。</p><p>执行 kubeadm join 以加入其他节点，此时需要 kubeadm init 时的输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure><p>如果忘记记录，则可以在 master 节点执行以下命令找回 token:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>默认 token 的有效期为 24h，超过时间可以创建新的 token:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create</span><br></pre></td></tr></table></figure><p>由于目前只有一台主机，后续测试多节点的加入移除。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network">Creating a single master cluster with kubeadm</a></li><li><a target="_blank" rel="noopener" href="https://ieevee.com/tech/2018/09/01/kubeadm.html">墙内安装kubernetes教程</a></li><li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">Installing kubeadm</a></li></ul><p>-EOF-</p><div class="article-copyright"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external"><span class="icon icon-creative-commons"></span> <span>本博客所有文章除特别声明外，均采用 CC BY-NC-ND 4.0 许可协议。转载请注明出处！</span> </a><a href="https://rainylog.com">&copy; 雨落</a></div></div><div class="article-tags"><a class="tag-none-link" href="/tags/docker/" rel="tag">docker</a><a class="tag-none-link" href="/tags/k8s/" rel="tag">k8s</a></div><nav class="article-nav clearfix"><a href="/post/js-site/" class="article-nav-newer"><div class="article-nav-title">js 零散记录</div></a><a href="/post/laptop-to-server/" class="article-nav-older"><div class="article-nav-title">笔记本服务器改造踩坑</div></a></nav><section id="comments" class="white-box"></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://rainylog.com">雨落</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external noopener">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">kubeadm 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm-init-%E8%B8%A9%E5%9D%91"><span class="toc-number">2.</span> <span class="toc-text">kubeadm init 踩坑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%B3%95%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F"><span class="toc-number">3.</span> <span class="toc-text">无法下载镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">安装网络插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Pod"><span class="toc-number">5.</span> <span class="toc-text">创建 Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.gif"></div><div class="info"><a class="name dark-btn" href="/about">Rainy</a></div><div class="info"><span class="item desc">沉淀，分享。</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto://geekrainy@gmail.com" class="email" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/geekrainy" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://weibo.com/geekrainy" class="weibo" target="_blank" rel="external"><span class="icon icon-weibo"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="rainylog",AZURE_INDEX_NAME="rainylog",AZURE_QUERY_KEY="FDEE6CFE3AB9A25E574BBCB873B29595",BAIDU_API_ID="",SEARCH_SERVICE="azure"</script><script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script type="text/javascript">var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!0,notify:!0,appId:"H90zpiwhe0XxV8Kb8n6BplHo-MdYXbMMI",appKey:"974axFeQbAqLnxwJIRgc1xHa",placeholder:"Just go go",avatar:"retro",meta:guest,pageSize:10,visitor:!0})</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>