<!DOCTYPE html><html><head><meta charset="utf-8"><title>简谈性能优化（上） | 雨落</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="本文以及接下来的两篇文章会讨论一些性能优化相关的知识，分为上、中、下三个部分。第一部分讨论性能分析的基础内容，第二部分讨论实际的性能分析、调优及测试，第三部分讨论虚拟化环境和云计算环境下的性能。文章内容来自于阅读《图解性能优化》一书的相关笔记和知识整理以及自己的理解。 转在此处自己对于本书的豆瓣书评。  作者给出的是一种总揽大局的思维观念，而并非详细的性能解决方式。它只是提供了一些角度去考虑性能问"><meta property="og:type" content="article"><meta property="og:title" content="简谈性能优化（上）"><meta property="og:url" content="https://rainylog.com/post/performance-optimization-1/index.html"><meta property="og:site_name" content="雨落"><meta property="og:description" content="本文以及接下来的两篇文章会讨论一些性能优化相关的知识，分为上、中、下三个部分。第一部分讨论性能分析的基础内容，第二部分讨论实际的性能分析、调优及测试，第三部分讨论虚拟化环境和云计算环境下的性能。文章内容来自于阅读《图解性能优化》一书的相关笔记和知识整理以及自己的理解。 转在此处自己对于本书的豆瓣书评。  作者给出的是一种总揽大局的思维观念，而并非详细的性能解决方式。它只是提供了一些角度去考虑性能问"><meta property="og:locale"><meta property="article:published_time" content="2017-04-15T13:06:16.000Z"><meta property="article:modified_time" content="2020-12-29T13:35:51.529Z"><meta property="article:author" content="Rainy"><meta property="article:tag" content="笔记"><meta property="article:tag" content="阅读"><meta property="article:tag" content="性能"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Crimson+Text" rel="stylesheet"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-99171848-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-99171848-1")</script><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><meta name="generator" content="Hexo 5.1.0"><link rel="alternate" href="/atom.xml" title="雨落" type="application/atom+xml">
</head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">雨 </span><span class="b">落 </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-performance-optimization-1" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">简谈性能优化（上）</h1><div class="article-meta">Posted on <time class="article-time" datetime="2017-04-15T13:06:16.000Z" itemprop="datePublished">Apr 15, 2017</time></div></header><div class="article-entry" itemprop="articleBody"><p>本文以及接下来的两篇文章会讨论一些性能优化相关的知识，分为上、中、下三个部分。第一部分讨论性能分析的基础内容，第二部分讨论实际的性能分析、调优及测试，第三部分讨论虚拟化环境和云计算环境下的性能。文章内容来自于阅读《图解性能优化》一书的相关笔记和知识整理以及自己的理解。</p><p>转在此处自己对于本书的豆瓣书评。</p><blockquote><p>作者给出的是一种总揽大局的思维观念，而并非详细的性能解决方式。它只是提供了一些角度去考虑性能问题，怎样排查性能问题，怎样解决的途径和突破点可能在何处。书中的示例也并非适用于所有的架构，但可以类比相似的解决方案到其他系统。如果事先没有对网络知识有一定了解，就不能理解在网络过程中存在的性能瓶颈，对操作系统的内在结构不熟悉，也就无法体会中断处理、锁机制等等对性能开销带来的影响。所以工程应用的解决方案往往是科学问题，这些是计算系统架构的底层和基础。</p><p>《图解性能优化》重在图解，但同所有的图解类图书一般，图虽浅显但也局限。只是更容易去理解一种思路，并不能带来知识体系的丰富。对于硬件性能的优化，也没有机会去实践。作为软件开发人员，也给了一种全局观察整个架构的机会。方法是次要的，基础扎实可以创造方法，书是引路人，只是让我们走得更容易些。对于经验丰富的工程师而言，经验已经融入血液，遇到问题可以四两拨千斤，迅速定位。作者能给出浅显的经验和解决方式是很棒的，软技能也存在与书中很多地方，能讲出来已经是读者的一种幸运。——@<a target="_blank" rel="noopener" href="https://www.douban.com/people/rainylog/">Rainy</a></p></blockquote><h2 id="性能的基础知识"><a href="#性能的基础知识" class="headerlink" title="性能的基础知识"></a>性能的基础知识</h2><p>性能问题的发生往往归结于软件问题和硬件问题两个方面。这里的软件问题是指“应用服务”软件，深入到软件的核心，是各种算法带来的性能差距。经典算法和数据结构已经非常成熟，由软件造成的性能表现不佳也极可能是对算法应用的不合理。各种算法都有其相应的适用场景，对算法数据结构优缺点的把握则是设计良好软件和架构的基础。而算法也并非完全适应与某一个场景，重要的是“折中”思维。性能问题往往都是速度和成本的权衡，算法也亦然。例如索引可以加快查找速度，但少量查找时又显得多余，预见到未来查找的增加，进行数据索引还是有必要的过程。下面来简要概述与性能有关的一些算法及优缺点：</p><h3 id="性能与算法"><a href="#性能与算法" class="headerlink" title="性能与算法"></a>性能与算法</h3><table><thead><tr><th>算法</th><th align="left">优点</th><th>缺点</th><th>改进变种</th></tr></thead><tbody><tr><td>数组O(n)</td><td align="left">善于循环处理，按序存放、查找数据</td><td>未知数组长度，浪费内存空间，数据增多时修改不易</td><td>数组的数组，用一个数组来添加位置变量</td></tr><tr><td>链表O(n)</td><td align="left">管理容易变化的数据，增删数据方便</td><td>需要访问动态计算的地址，无法直接同数组下标般找到位置，只能遍历</td><td>双向链表</td></tr><tr><td>树O(logn)</td><td align="left">随数据增加复杂度增加缓慢，查找范围逐渐缩小</td><td>数据更新不便，删除数据造成空位，影响性能，导致索引碎片化</td><td>n叉树、B树、B+树、B*树</td></tr><tr><td>散列算法O(1)</td><td align="left">消除数据的不平衡，直接查找</td><td>相同数据、相同散列值出现碰撞</td><td>以链表结构连接，“重散列”</td></tr><tr><td>队列O(1)</td><td align="left">大量处理，先入队列，分割事务（缓冲）</td><td>队列溢出的情况</td><td>数组连接的环形结构的队列，用树结构实现快速查找的队列</td></tr><tr><td>栈O(1)</td><td align="left">只占用必要空间，无碎片</td><td>适用情况少</td><td>栈轨迹，以栈形式展现函数调用</td></tr><tr><td>快速排序O(nlogn)</td><td align="left">加快查找时间，了解重复情况</td><td>对频繁查找有价值，对少量查找则费时间</td><td>归并排序</td></tr><tr><td>缓存（回写）</td><td align="left">不用等待写入延时</td><td>可能导致缓存丢失时出现数据不一致现象</td><td>非易失性(Non-volatile)、电池备份来解决数据丢失</td></tr><tr><td>缓存（直写）</td><td align="left">数据较快地读取和写入</td><td>响应变慢</td><td>关机缓存步骤，DBMS日志实时写入</td></tr></tbody></table><h3 id="锁与性能"><a href="#锁与性能" class="headerlink" title="锁与性能"></a>锁与性能</h3><p>锁机制是为保护数据的完整性及保证数据同步而存在于并行处理中的一种方式，而当锁出现了锁等待，则会形成请求队列。造成请求堆积而导致性能下降，所以需要减少锁等待的发生。</p><p>对 DB 而言，提高对表加锁的 SQL 处理速度，可以尽快释放锁。或对行加锁来并行执行，就可以通过分割锁的方式来减少等待时间。</p><h3 id="响应与吞吐"><a href="#响应与吞吐" class="headerlink" title="响应与吞吐"></a>响应与吞吐</h3><p>考虑性能时，响应与吞吐是两个重要的概念。响应是应答快慢，而吞吐是处理数量。有的系统偏重于响应，而有的偏重于吞吐。通过升级硬件来提高响应速度，一般也会提高吞吐，但升级不是无限的，有它的瓶颈和上限。吞吐不够时，增加响应只是增加了空转的硬件，并不能解决问题。所以当出现性能问题时，要判断是响应问题还是吞吐问题，对症下药。</p><h2 id="性能分析的基础"><a href="#性能分析的基础" class="headerlink" title="性能分析的基础"></a>性能分析的基础</h2><p>要进行性能分析首先要进行性能测量，找出问题所在。而性能测量也就是性能分析的原则，首先要从时间和位置两个角度考虑，也就是“分段查找”的思想。从时间角度是测量某个时间段内的性能信息来进行分析，而位置角度则是测量可能发生性能问题的位置进行定点测量，各个击破。并且在测量过程中，也要考虑性能测量工具的负载对系统的影响。避免对性能信息进行误判。</p><p>作者将性能信息分为三类：</p><ol><li>概要形式。获得的是某段时间内的平均值，适合快速掌握初步信息。</li><li>事件记录形式。获得的是“某时某刻谁做了什么”之类的详细信息，对系统压力较大。不适合经常在生产环境中使用。</li><li>快照形式。记录某一瞬间的信息，适合查找引起性能问题的原因。</li></ol><p>三类信息获得之后进行结合分析，来找出问题所在。而获取三类信息的相应工具和命令，会在下面给出。</p><h3 id="等待队列理论"><a href="#等待队列理论" class="headerlink" title="等待队列理论"></a>等待队列理论</h3><p>在性能方面，“等待队列理论”具有很强的代表性。首先，队列中的等待时间称为“访问等待时间”，有如下关系：</p><blockquote><p>响应时间 = 访问等待时间 + 服务时间</p></blockquote><p>等待队列可以表示为”M/M/1”。分别表示请求到达时间的特征，服务时间的特征，处理的并行程度（1 指线性处理）。因为请求是完全随机的，所以出现短暂的大量请求，也会产生等待队列。</p><p>假设处理时间是 1 秒，每小时处理的条数是 3000 条。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ρ(平均使用率) = [<span class="number">1</span>(处理时间)×<span class="number">3000</span>(处理条数)]/<span class="number">3600</span>(单位时间) = <span class="number">0.83</span></span><br><span class="line">等待时间/<span class="number">1</span>秒 = <span class="number">0.83</span>/（<span class="number">1</span><span class="number">-0.83</span>）= <span class="number">4.88</span></span><br><span class="line">响应时间 = <span class="number">4.88</span>(等待时间)+<span class="number">1</span>(处理时间)</span><br></pre></td></tr></table></figure><p>由上面的式子可以看出，当平均使用率增加的时候，等待时间呈指数级别增加。</p><p>在 CPU 使用率的统计工具中，有时可以看到尖峰的出现。频繁的尖峰出现往往是系统出现问题的前兆，但少数尖峰的出现是允许存在的，使用超线程可以改善此现象。然而在批处理中不应该存在这样的情况，处理时间久也不会导致等待队列的变长，由于不能通过等待队列的情况来判断性能问题，这时就应判断单个处理器的时间长度了。</p><p>当调查引起性能问题的原因时，需要确定一些必要的检测信息。而对于需要获得哪些信息，并没有统一的标准。需要按照实际情况去确认。</p><h3 id="获取性能信息的-OS-命令"><a href="#获取性能信息的-OS-命令" class="headerlink" title="获取性能信息的 OS 命令"></a>获取性能信息的 OS 命令</h3><p>对于获取性能信息的方式，需要了解一些获得信息的 OS 命令。对于 Linux 主要通过内置的命令来获得，Windows 大都是获取相应信息的图形化界面。此外有时还需要其他的工具或软件，例如对网络进行性能分析时，需要使用 Wireshark 来进行抓包分析。下面简要介绍相关命令，具体使用可查阅相关手册（提供的是获得信息的方式和思路，而非详细的使用和操作步骤）。</p><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>对于 Linux 而言，获取性能信息的 OS 命令可以根据性能信息的分类如下：</p><ol><li><p>获取概要信息：</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sar,</span> vmstat, netstat, iostat, profiler</span><br></pre></td></tr></table></figure></li><li><p>获取快照信息：</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ps,</span> netstat, top, pstack</span><br></pre></td></tr></table></figure></li><li><p>事件记录形式的信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">数据包转储程序, strace</span><br></pre></td></tr></table></figure></li></ol><h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>Windows 的性能信息工具往往隐藏在控制面板的各个角落，比较有用的有任务管理器、性能监视器、资源监视器等。</p><hr><p>关于性能优化的基础部分谈到这里，第二部分将会谈到实际的性能优化、分析及调优。</p><div class="article-copyright"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" rel="external"><span class="icon icon-creative-commons"></span> <span>本博客所有文章除特别声明外，均采用 CC BY-NC-ND 4.0 许可协议。转载请注明出处！</span> </a><a href="https://rainylog.com">&copy; 雨落</a></div></div><div class="article-tags"><a class="tag-none-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a><a class="tag-none-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a><a class="tag-none-link" href="/tags/%E9%98%85%E8%AF%BB/" rel="tag">阅读</a></div><nav class="article-nav clearfix"><a href="/post/what-methods-of-clearfix-can-i-use/" class="article-nav-newer"><div class="article-nav-title">译：可以用什么方法清除浮动？</div></a><a href="/post/hexo-post-image-manage/" class="article-nav-older"><div class="article-nav-title">Hexo 文章图片管理</div></a></nav><section id="comments" class="white-box"></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://rainylog.com">雨落</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a target="_blank" href="https://hexo.io/" rel="external noopener">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9A%84%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">性能的基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E4%B8%8E%E7%AE%97%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">性能与算法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E4%B8%8E%E6%80%A7%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">锁与性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E4%B8%8E%E5%90%9E%E5%90%90"><span class="toc-number">1.3.</span> <span class="toc-text">响应与吞吐</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E7%9A%84%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">性能分析的基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%E7%90%86%E8%AE%BA"><span class="toc-number">2.1.</span> <span class="toc-text">等待队列理论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%80%A7%E8%83%BD%E4%BF%A1%E6%81%AF%E7%9A%84-OS-%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">获取性能信息的 OS 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux"><span class="toc-number">2.2.1.</span> <span class="toc-text">Linux</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows"><span class="toc-number">2.2.2.</span> <span class="toc-text">Windows</span></a></li></ol></li></ol></li></ol></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.gif"></div><div class="info"><a class="name dark-btn" href="/about">Rainy</a></div><div class="info"><span class="item desc">沉淀，分享。</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="mailto://geekrainy@gmail.com" class="email" target="_blank" rel="external"><span class="icon icon-mail"></span> </a><a href="https://github.com/geekrainy" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://weibo.com/geekrainy" class="weibo" target="_blank" rel="external"><span class="icon icon-weibo"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="rainylog",AZURE_INDEX_NAME="rainylog",AZURE_QUERY_KEY="FDEE6CFE3AB9A25E574BBCB873B29595",BAIDU_API_ID="",SEARCH_SERVICE="azure"</script><script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script type="text/javascript">var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!0,notify:!0,appId:"H90zpiwhe0XxV8Kb8n6BplHo-MdYXbMMI",appKey:"974axFeQbAqLnxwJIRgc1xHa",placeholder:"Just go go",avatar:"retro",meta:guest,pageSize:10,visitor:!0})</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>